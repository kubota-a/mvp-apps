# 📘 MVP-01 role-todo（ロール別ToDo管理システム）

本リポジトリは、業務アプリ開発の基礎（CRUD / ロール / 状態遷移 / 大量フォーム など）を習得するための  
**MVP（Minimum Viable Product）形式の学習用アプリケーション**です。

本 README では、実装前に行う **設計ドキュメント（0〜9）** をまとめています。  
実装後の資料（マニュアル / プレゼン / テストレポート）は `docs/` に格納します。

---

# 0. 📒 設計（System Design）

## 🧩 本MVPの目的（クライアント課題への対応）

- 誰が何を担当しているかを可視化する  
- 管理者が進捗を把握できるようにする  
- 完了状態を明確にする  

そのために、ロール別制御とステータス管理を備えた  
最小構成のToDo管理システムを構築する。

---
## 📌 業務ルール
課題文で例にあがっていた下記を採用：
- ステータス（着手前 / 進行中 / 完了）を持つ
理由：  
クライアントの課題「管理者が進捗を把握できない・ToDoが完了したかどうか曖昧」を解決できるため。
設計：
- 「完了」はチェック操作で行う
- 完了済みタスクは編集不可（ご更新防止）

---

## ✅ 必須機能（課題文で要求されている範囲）

### 🔐 認証
- ログイン機能

### 🛡 ロール
- 一般ユーザー
- 管理者

### 📝 ToDo管理（CRUD）

#### ●一般ユーザー
- 自分のToDoのみ  
  - 新規作成  
  - 編集  
  - 削除（削除は論理削除とし、削除済みはdeleted_at に日時を入れて一覧から除外・通常の一覧では deleted_at IS NULL のものだけ表示）  
  - 一覧表示（ステータスごとのカンバン形式で表示）

#### ●管理者
- 全ユーザーのToDo  
  - 一覧表示（ステータスごとのカンバン形式で表示）  
  - 新規作成  
  - 編集  
  - 削除（削除は論理削除とし、削除済みはdeleted_at に日時を入れて一覧から除外・通常の一覧では deleted_at IS NULL のものだけ表示）   

### 🔎 ロール別制御
- 一般ユーザーは自分のToDoのみ編集・削除可能
- 管理者は全ユーザーのToDoを閲覧・編集・削除できる  
  （理由：進捗調整や業務フォローを円滑に行うため）

---

## 📌 任意実装（完成後に余力があれば実装）

- タスクの期日表示および期日による並べ替え
※以降、すべて管理者側の機能
- 管理者用ダッシュボード（件数表示）
- ステータス絞り込み検索
- 完了率表示
- 管理者による一般ユーザーのアカウント作成（初期運用では管理者は最小人数とし、原則として一般ユーザーを追加する）
- ユーザー一覧表示
- ユーザー情報の編集および削除

---

## 🎯 完成定義
以下を満たした時点で完成とする：

### ☑️ 機能面
- 必須機能がすべて動作する
- ステータス（着手前 / 進行中 / 完了）が操作できる

---

### 🛡 セキュリティ・基本品質

- パスワードハッシュ化
- ログイン必須制御
- ロールチェック
- CSRF対策
- SECRET_KEY・DATABASE_URLは環境変数管理
- SQLAlchemy使用によるSQLインジェクション対策

---

### ⚠ エラー処理

- 404（存在しないデータ）
- 403（権限不足）
- 入力不正時のバリデーションエラー表示

---

## ✂ 現段階では削る機能（スコープ外）

- 通知機能（リアルタイム処理や設計負荷が高いため） 
- 担当変更や完了などの申請フロー（業務フローが複雑化するため）   
- リマインダー（今回の業務ルール外のため）   
- 監査ログ（データ設計が拡張的になるため）   
- アカウントロック／レート制限（セキュリティ高度化は本番運用フェーズで検討）   
- 個人情報のアプリケーションレベルの暗号化＋鍵管理（鍵の管理が必要になるため本番運用フェーズで検討）
- 例外網羅やCookie制御などの高度なエラー処理（エラー処理の高度化は本番運用フェーズで検討）

**方針：**  
MVPではコア業務フロー（ロール制御＋ステータス管理）を優先する。

---

## 💡 本番運用を見据えた改善提案（課題2想定）

本プロトタイプは最小構成であるため、実運用では以下の整備を段階的に検討する。

### 1. 完了定義の明確化
- 軽微タスクは自己完了
- 重要タスクは承認制
- 再対応ルールの明文化

### 2. 担当変更ルールの標準化
- 変更理由の記録
- 変更履歴の保持
- 権限の明確化

### 3. 見落とし防止の運用整備
- 毎日の未完了確認ルーチン
- 滞留タスクの可視化
- 週次レビュー運用

### 4. 権限設計の拡張
- チーム単位閲覧制御
- 中間ロール追加
- プロジェクト単位管理

### 5. セキュリティポリシー整備
- 更新履歴保持方針
- ログ保存期間
- 将来的な多段階認証導入

### 6. 論理削除後の運用上の保持期間を定める
- 論理削除後3か月などを定め、期間終了後は必要ならバッチで物理削除

### 7. 管理者側の検索機能の拡張
- ユーザー絞り込み検索
- キーワード検索
- ソート

### 8. 本番運用でデータ量が増えた場合のDBチューニング
本MVPではインデックス設計を最小限に留めているが、  
本番運用でタスク数・ユーザー数が増加した場合には、以下の最適化を検討する。
- 論理削除カラムを条件にしたパーティアルインデックスの付与  
  例：`WHERE deleted_at IS NULL` を条件としたインデックスを作成し、  
    一覧表示で使用する「未削除タスク」の検索性能を最適化する
- 一般ユーザーのタスク一覧（期限順）向けの複合インデックスの追加  
  例：`tasks(user_id, due_at)` にパーティアル複合インデックスを付与し、  
    「自分のタスクを期限が近い順に表示する」クエリの性能を改善する

---

# 1. 🔑 テストアカウント（Test Accounts）

アプリの動作確認用に、以下のテストアカウントを用意しています。

| ロール | userid | password |
|--------|--------|----------|
| 一般ユーザー | user1 | pass1 |
| 管理者 | admin | adminpass |

※ 実際のMVPに合わせて変更してください。

---

# 2. 🗺 画面遷移図（Screen Flow）

画面構成と遷移を以下に示す。

> **※画像は `images/screen-flow.png` として配置を想定**

![画面遷移図](./images/screen-flow.png)

### 主な画面
- `/login` … ログイン
- `/` … 一覧
- `/create` … 新規作成
- `/edit/<id>` … 編集
- `/delete/<id>` … 削除確認

---

# 3. 🗄 テーブル設計・ER図（Database Design）

本アプリで使用するテーブル構造を以下に示す。

> **※図は `images/er.png` を参照**  
> （tasks.user_id にインデックス付与を示す記号を追加）

![ER図](./images/er.png)

---

## 📌 テーブル一覧

- `users`（ユーザー情報）
- `tasks`（タスク情報）
- `statuses`（タスクの状態マスタ）

---

## 🔗 テーブル間の関係

- **users 1 : N tasks**  
　（1人のユーザーが複数のタスクを持つ）

- **statuses 1 : N tasks**  
　（1つのステータスが複数のタスクに紐づく）

---

## 📋 各テーブル詳細

---

### 🧍‍♂️ users（ユーザー情報）

| カラム名 | 型 | 説明 |
|---------|-----|-------|
| id | BIGSERIAL | 主キー（PK） |
| login_id | VARCHAR(50) | ログインID（UNIQUE / NOT NULL）※ログイン時の検索高速化のためインデックス付与 |
| password_hash | VARCHAR(255) | パスワード（ハッシュ化 / NOT NULL） |
| name | VARCHAR(50) | 氏名（表示名 / NOT NULL） |
| role | VARCHAR(20) | ロール（`user` / `admin` のみ許可・CHECK制約 / NOT NULL） |
| created_at | TIMESTAMP WITH TIME ZONE | 作成日時（NOT NULL / 自動付与） |

---

### 📝 tasks（タスク情報）

| カラム名 | 型 | 説明 |
|---------|-----|-------|
| id | BIGSERIAL | 主キー（PK） |
| user_id | BIGINT | 担当者（FK → users.id / NOT NULL / **一覧取得で頻繁に利用するためインデックス付与**） |
| status_id | SMALLINT | ステータス（FK → statuses.id / NOT NULL） |
| title | VARCHAR(100) | タスク内容（NOT NULL） |
| due_at | TIMESTAMP WITH TIME ZONE | 期限日時（NOT NULL） |
| created_at | TIMESTAMP WITH TIME ZONE | 作成日時（NOT NULL） |
| updated_at | TIMESTAMP WITH TIME ZONE | 更新日時（NOT NULL） |
| deleted_at | TIMESTAMP WITH TIME ZONE | 論理削除（NULL = 有効、日時が入れば削除扱い） |

---

### 🟦 statuses（ステータスマスタ）

| カラム名 | 型 | 説明 |
|---------|-----|-------|
| id | SMALLSERIAL | 主キー（PK） |
| name | VARCHAR(20) | ステータス名（UNIQUE / NOT NULL） |
| display_order | SMALLINT | UI 表示順（NOT NULL） |

---

## 📝 設計補足（運用・拡張性を考慮した仕様）

- タスクの論理削除は `deleted_at IS NULL` を前提に一覧取得
- ステータスはマスタテーブル化し、将来「保留中」「レビュー待ち」など拡張可能
- 一般ユーザーは自分の tasks のみ取得するため  
  `tasks.user_id` のインデックスが一覧表示の主要な高速化ポイント
- 本番運用規模では、`tasks(user_id, due_at)` の複合インデックス追加も検討（課題2に記載）

---

# 4. 🔗 URL と ルーティング一覧

| URL | メソッド | 画面 | ロール | 説明 |
|-----|----------|------|--------|------|
| `/` | GET | 一覧 | 全員 | 登録済データの一覧 |
| `/create` | GET/POST | 新規作成 | 一般/管理 | データ登録 |
| `/edit/<id>` | GET/POST | 編集 | 所有者 or 管理 | データ編集 |
| `/delete/<id>` | GET/POST | 削除確認 | 所有者 or 管理 | 削除処理 |
| `/login` | GET/POST | ログイン | 全員 | 認証 |

※ 実際のMVPの仕様に合わせて修正して使う。

---

# 5. 🛡 ロールと権限（Authorization）

アプリ内でのロールとアクセス可否を以下にまとめる：

| 機能 | ゲスト | 一般ユーザー | 管理者 |
|-------|--------|---------------|----------|
| ログイン | ○ | ○ | ○ |
| 一覧表示 | △（制限つき） | ○ | ○ |
| 新規作成 | × | ○ | ○ |
| 編集 | × | 所有データのみ | 全データ |
| 削除 | × | 所有データのみ | 全データ |

※ 赤枠部分（×/△/○）を MVP に合わせて編集して使う。

---

# 6. 🔄 データの流れ（Sequence）

例）「新規作成フロー」のデータ処理

1. 画面（/create）で入力  
2. バリデーション実行  
3. DB に insert  
4. 一覧ページへ redirect  
5. 一覧で最新データを取得して表示  

> ※ `images/sequence.png` に時系列図を置くと評価アップ

---

# 7. ✔ バリデーション方針

| 項目 | バリデーション内容 | 理由 |
|------|---------------------|------|
| title | 必須 / 1〜100文字 | 業務データとして必須 |
| body | 1〜1000文字 | 長文に対応 |
| user_id | 必須 / 整合性 | 不正アクセス防止 |

### その他
- CSRF あり（Flask-WTF 使用可）
- 一意性制約（必要な場合のみ）

---

# 8. ✂ 削った項目（Scope Cut）

MVP高速開発のため、以下の機能は今回含めない。

- ページング  
- 高度な検索機能  
- ダッシュボード  
- 画像アップロード  
- 状態遷移の複雑な分岐  

**理由：**  
- インターン課題では、100時間の中で「難易度調整」が評価されるため  
- まずコア業務フローを実装することを優先したため  

**本番ならこう実装する：**  
- ページングは Flask-Paginate  
- 検索は LIKE / 複数条件  
- 状態遷移は Enum × バリデーション

---

# 9. 🧪 テスト計画（Testing Plan）

> 詳細なテスト観点と実施状況は `docs/test-report.md` に記載。  
> ここでは “何を重点的にテストするか” をまとめる。

### 重点テスト観点
- CRUD が正しく行われるか  
- ログイン必須ページの保護  
- ロール別アクセスの確認  
- URL直打ち（404, 403）  
- バリデーション  

### 手動テストの方針
- UIの動作確認  
- 戻るボタンの動き  
- F5 / 連打による誤動作防止  
- 不正IDアクセス  

### 自動テスト（pytest）
- 認証  
- 認可  
- CRUD（1本）  

---

# 📂 その他資料（実装後）

- `docs/manual.md` … 使い方マニュアル  
- `docs/presentation.md` … プレゼン資料  
- `docs/test-report.md` … テスト詳細  
